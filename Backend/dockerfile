# =========================================================================
# Base Image with CUDA
# =========================================================================
FROM nvidia/cuda:12.1.1-devel-ubuntu22.04

WORKDIR /app

# ---------------------------
# Environment Variables
# ---------------------------
ENV MONGO_URI=mongodb://localhost:27017/
ENV REDIS_URL=redis://localhost:6379/0
ENV DEBIAN_FRONTEND=noninteractive

# ---------------------------
# Install OS Packages (MongoDB, Redis, Supervisor, Python)
# ---------------------------
RUN apt-get update && \
    apt-get install -y wget gnupg lsb-release curl git python3-pip supervisor && \
    # Install MongoDB
    curl -fsSL https://www.mongodb.org/static/pgp/server-6.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-server-6.0.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg] https://repo.mongodb.org/apt/ubuntu $(lsb_release -cs)/mongodb-org/6.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-6.0.list && \
    apt-get update && apt-get install -y mongodb-org && \
    # Install Redis
    apt-get install -y redis-server && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# ---------------------------
# Download TabPFN Model
# ---------------------------
ARG TABPFN_MODEL_URL="https://huggingface.co/Prior-Labs/TabPFN-v2-reg/resolve/main/tabpfn-v2-regressor.ckpt"
ARG DEFAULT_MODELS_DIR="/root/.cache/tabpfn"
ARG TABPFN_MODEL_FILENAME="tabpfn-v2-regressor.ckpt"

RUN mkdir -p ${DEFAULT_MODELS_DIR} && \
    wget -O "${DEFAULT_MODELS_DIR}/${TABPFN_MODEL_FILENAME}" ${TABPFN_MODEL_URL}

# ---------------------------
# Python Dependencies
# ---------------------------
COPY requirements.txt .
RUN pip3 install --upgrade pip && pip3 install --no-cache-dir -r requirements.txt

# ---------------------------
# Copy Application Code
# ---------------------------
COPY . .

# ---------------------------
# Supervisor Config
# ---------------------------
RUN mkdir -p /var/log/supervisor

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Expose Ports
EXPOSE 8000 27017 6379

# Start all processes via Supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]